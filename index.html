import tushare as ts
import pandas as pd

# 设置 TuShare Token
ts.set_token(6f4bb3282e834e7c85aa4b11bcfd56b8bddd899ea60e4660b67fa0caa7471f3f)  # 替换为你的API Key
pro = ts.pro_api()

# 获取股票和指数的历史数据
def get_stock_data(stock_code, start_date, end_date):
    # 获取股票历史数据
    stock_data = pro.daily(ts_code=stock_code, start_date=start_date, end_date=end_date)
    return stock_data

def get_index_data(index_code, start_date, end_date):
    # 获取指数历史数据
    index_data = pro.index_daily(ts_code=index_code, start_date=start_date, end_date=end_date)
    return index_data

def calculate_deviation(stock_data, index_data):
    # 合并数据，计算股票与指数的涨跌幅偏离值
    df = pd.merge(stock_data[['trade_date', 'close']], index_data[['trade_date', 'close']], on='trade_date', suffixes=('_stock', '_index'))

    # 计算每一天的涨跌幅
    df['stock_pct_change'] = df['close_stock'].pct_change() * 100
    df['index_pct_change'] = df['close_index'].pct_change() * 100

    # 计算偏离值
    df['deviation'] = df['stock_pct_change'] - df['index_pct_change']
    
    return df

def calculate_cumulative_deviation(deviation_series, period=10):
    # 计算累计偏离值
    cumulative_deviation = deviation_series.tail(period).sum()
    return cumulative_deviation

def predict_trigger_price(stock_data, index_data, period=10):
    # 假设股票日涨幅限制为10%
    max_increase_percentage = 10  # 股票日涨幅最大为10%
    
    df = calculate_deviation(stock_data, index_data)
    
    # 计算滚动的累计偏离值
    cumulative_deviation = calculate_cumulative_deviation(df['deviation'], period)

    # 根据累计偏离值来预测价格
    # 假设，如果偏离值累计达到100%（即，股票涨幅将达到10%）
    trigger_price = stock_data['close'].iloc[-1] * (1 + max_increase_percentage / 100)
    return trigger_price, cumulative_deviation

# 示例：获取A股股票（如：600519.SH）与上证综指的历史数据
stock_code = '600519.SH'
index_code = '000001.SH'  # 上证综指

# 获取数据
stock_data = get_stock_data(stock_code, '20230101', '20230815')
index_data = get_index_data(index_code, '20230101', '20230815')

# 计算预测价格和累计偏离值
predict_price, cumulative_deviation = predict_trigger_price(stock_data, index_data, period=10)
print(f"预测触发价格: {predict_price}")
print(f"10日累计偏离值: {cumulative_deviation}")
